# OpenAI Realtime Speech-to-Speech Conversation Flow

## Complete Conversation Lifecycle Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INCOMING CALL RECEIVED                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   handleIncomingCall(call)             â”‚
        â”‚   - Create OpenAI handler instance     â”‚
        â”‚   - Set up call event handlers         â”‚
        â”‚   - Answer call immediately           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Connect to OpenAI (Background, non-blocking)  â”‚
        â”‚  - WebSocket connection established           â”‚
        â”‚  - Session configuration sent                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Call Media Available (media event)         â”‚
        â”‚  - Audio streams ready                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
         â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Play Connection â”‚        â”‚ Attach OpenAI to Call   â”‚
    â”‚ Beep (440Hz)    â”‚        â”‚ - Setup audio capture   â”‚
    â”‚ Duration: 400ms â”‚        â”‚ - Create recorder       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ - Create player         â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ sendInitialGreeting()         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                       â”‚
                    â–¼                                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Cached Greeting Exists? â”‚        â”‚ No Cached Greeting         â”‚
        â”‚ Check /tmp/...cached.wavâ”‚        â”‚ generateNewGreeting()      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ YES                     â”‚          â”‚ Send to OpenAI:          â”‚
        â”‚ Play existing greeting  â”‚          â”‚ response.create          â”‚
        â”‚                         â”‚          â”‚ + Instructions for       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   greeting               â”‚
                  â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                                      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ OpenAI Generates Response         â”‚
                 â”‚ response.audio.delta (chunks)     â”‚
                 â”‚ - Audio streamed in real-time     â”‚
                 â”‚ - Converted to WAV                â”‚
                 â”‚ - Played to caller via SIP        â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ response.done received         â”‚
                 â”‚ - Greeting complete           â”‚
                 â”‚ - Greeting cached for future  â”‚
                 â”‚ - AI ready for conversation   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    NORMAL CONVERSATION STARTS                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CALLER SPEAKS                                   â”‚
        â”‚ Audio captured from SIP call                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ input_audio_buffer.speech_started              â”‚
        â”‚ - VAD detects voice activity                   â”‚
        â”‚ - Threshold: 0.5                               â”‚
        â”‚ - Prefix padding: 300ms                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ setupAudioCapture() Monitoring Loop (100ms)    â”‚
        â”‚ - Read new data from /tmp/caller_audio_*.wav   â”‚
        â”‚ - Extract PCM data (skip 44-byte header)       â”‚
        â”‚ - Convert to Base64                            â”‚
        â”‚ - Send via input_audio_buffer.append           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Audio Chunks     â”‚  â”‚ Chunks Continue  â”‚
        â”‚ Streamed         â”‚  â”‚ Every 100ms      â”‚
        â”‚ input_audio_     â”‚  â”‚ Until Silence    â”‚
        â”‚ buffer.append    â”‚  â”‚ Detected         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ input_audio_buffer.speech_stopped              â”‚
        â”‚ - Silence detected                             â”‚
        â”‚ - Duration: 1000ms (1 second)                  â”‚
        â”‚ - VAD determines user finished speaking        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ commitAudioBuffer()  â­ CRITICAL               â”‚
        â”‚ - Send input_audio_buffer.commit               â”‚
        â”‚ - Signal: "User input complete"                â”‚
        â”‚ - Enable turn-taking                           â”‚
        â”‚ - Trigger OpenAI processing                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ OpenAI Processing (Server-side)                â”‚
        â”‚ - Transcribe audio (Whisper-1)                 â”‚
        â”‚ - Understand intent                            â”‚
        â”‚ - Generate response                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ response.created event                         â”‚
        â”‚ - OpenAI starting to generate response         â”‚
        â”‚ - Modalities: text & audio                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ response.audio.delta (Stream of Chunks)        â”‚
        â”‚ - Real-time audio streaming                    â”‚
        â”‚ - Base64 encoded PCM16 data                    â”‚
        â”‚ - Multiple deltas per response                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Each Delta:      â”‚  â”‚ playAudioToSIP() â”‚
        â”‚ 1. Decode B64    â”‚  â”‚ 1. Create WAV    â”‚
        â”‚ 2. Add WAV       â”‚  â”‚    header        â”‚
        â”‚    header        â”‚  â”‚ 2. Write temp    â”‚
        â”‚ 3. Write temp    â”‚  â”‚    file          â”‚
        â”‚    file to /tmp  â”‚  â”‚ 3. Create player â”‚
        â”‚ 4. Create player â”‚  â”‚ 4. Play to SIP   â”‚
        â”‚ 5. Play to SIP   â”‚  â”‚    media stream  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CALLER HEARS AI RESPONSE (Real-time)           â”‚
        â”‚ - Audio plays immediately as chunks arrive     â”‚
        â”‚ - No waiting for complete response             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ response.audio.done                            â”‚
        â”‚ - All audio chunks sent                        â”‚
        â”‚ - Response playback may still be ongoing       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ response.done                                  â”‚
        â”‚ - Response complete                           â”‚
        â”‚ - Ready for next turn                          â”‚
        â”‚ - Back to listening for caller                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ LOOP BACK to:                 â”‚
                â”‚ - input_audio_buffer.        â”‚
                â”‚   speech_started/stopped     â”‚
                â”‚ - Continuous conversation    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Flow Breakdown

### Phase 1: Call Setup (0-2 seconds)

```
SIP Call Arrives
      â”‚
      â”œâ”€â–º handleIncomingCall()
      â”‚   â”œâ”€â–º Answer call immediately
      â”‚   â””â”€â–º Connect to OpenAI (async)
      â”‚
      â””â”€â–º setupCallHandlers()
          â”œâ”€â–º Listen for state changes
          â”œâ”€â–º Listen for media availability
          â””â”€â–º Listen for DTMF digits

          Media Available
          â”œâ”€â–º Play connection beep (440Hz, 400ms)
          â””â”€â–º connectAIToCall()
              â”œâ”€â–º Create recorder
              â”œâ”€â–º Setup audio capture monitoring
              â””â”€â–º Create audio player
```

### Phase 2: Initial Greeting (2-5 seconds)

```
attachToCall()
    â”‚
    â”œâ”€â–º playConnectionBeep() [400ms]
    â”‚
    â””â”€â–º sendInitialGreeting() [500ms delay]
        â”‚
        â”œâ”€â–º Check cache: /tmp/ai_greeting_cached.wav
        â”‚   â”‚
        â”‚   â”œâ”€â–º EXISTS: playExistingGreeting()
        â”‚   â”‚   â””â”€â–º Play cached greeting [~3 seconds]
        â”‚   â”‚
        â”‚   â””â”€â–º NOT EXISTS: generateNewGreeting()
        â”‚       â”‚
        â”‚       â””â”€â–º response.create
        â”‚           {
        â”‚             type: 'response.create',
        â”‚             response: {
        â”‚               modalities: ['text', 'audio'],
        â”‚               instructions: 'Greet...',
        â”‚               voice: 'alloy'
        â”‚             }
        â”‚           }
        â”‚
        â””â”€â–º Receive response.audio.delta chunks
            â””â”€â–º playAudioToSIP() for each chunk
                â””â”€â–º Cache audio for future use
```

### Phase 3: Turn-Taking Loop (5+ seconds)

```
LISTENER STATE
â”œâ”€â–º input_audio_buffer.speech_started
â”‚   â””â”€â–º Console: "ğŸ¤ User started speaking"
â”‚
â””â”€â–º SPEAKING STATE
    â”œâ”€â–º VAD Active: collecting audio
    â”œâ”€â–º setupAudioCapture() runs every 100ms
    â”‚   â”œâ”€â–º Check /tmp/caller_audio_*.wav for new data
    â”‚   â”œâ”€â–º Extract PCM16 (skip 44-byte header)
    â”‚   â”œâ”€â–º Base64 encode
    â”‚   â””â”€â–º Send input_audio_buffer.append
    â”‚
    â””â”€â–º input_audio_buffer.speech_stopped
        â””â”€â–º commitAudioBuffer()
            â”‚
            â””â”€â–º input_audio_buffer.commit sent
                â”‚
                â””â”€â–º OpenAI Processing
                    â”œâ”€â–º Transcribe: Whisper-1
                    â”œâ”€â–º Understand: Intent processing
                    â”œâ”€â–º Generate: Response creation
                    â”‚
                    â””â”€â–º Respond with audio
                        â””â”€â–º response.audio.delta (stream)
                            â”œâ”€â–º Decode Base64
                            â”œâ”€â–º Create WAV
                            â””â”€â–º Play to SIP
                                â”‚
                                â””â”€â–º response.done
                                    â””â”€â–º BACK TO LISTENER STATE
```

---

## Message Sequence Diagram

```
Caller              SIP Stack         App Handler          OpenAI API
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚â”€â”€â”€ Call Incoming â”€â†’â”‚                   â”‚                    â”‚
  â”‚                   â”‚â”€â”€â”€ call event â”€â”€â”€â”€â†’â”‚                    â”‚
  â”‚                   â”‚                   â”‚â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                   â”‚                   â”‚â† (connection)       â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚ â—„â”€ Beep â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—„â”€ Audio Play â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚                   â”‚                   â”‚â† greeting.create â”€â”€â”‚
  â”‚ â—„â”€ Greeting Audio â—„â”€ Audio Stream â”€â”€â”€â”€â”‚â† audio.delta â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚â”€â”€â”€ User Speaks â”€â”€â†’â”‚                   â”‚                    â”‚
  â”‚                   â”‚â”€ Record Audio â”€â”€â”€â”€â†’â”‚                    â”‚
  â”‚                   â”‚                   â”‚â”€ audio.append â”€â”€â”€â”€â†’â”‚
  â”‚                   â”‚                   â”‚â”€ audio.append â”€â”€â”€â”€â†’â”‚
  â”‚                   â”‚                   â”‚â”€ audio.append â”€â”€â”€â”€â†’â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚ (silence detected)â”‚                   â”‚                    â”‚
  â”‚                   â”‚                   â”‚â”€ audio.commit â”€â”€â”€â”€â†’â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚                   â”‚                   â”‚â† response.create â”€â”€â”‚
  â”‚                   â”‚                   â”‚â† audio.delta â”€â”€â”€â”€â”€â”€â”‚
  â”‚ â—„â”€ Response â”€â”€â”€â”€â”€â”€ â—„â”€ Audio Play â”€â”€â”€â”€â”€â”‚â† audio.delta â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                   â”‚â† audio.done â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                   â”‚â† response.done â”€â”€â”€â”€â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚                   â”‚                   â”‚ (back to listening)â”‚
  â”‚â”€â”€â”€ User Speaks â”€â”€â†’â”‚                   â”‚                    â”‚
  â”‚                   â”‚ (repeat loop...)  â”‚                    â”‚
  â”‚                   â”‚                   â”‚                    â”‚
  â”‚â”€â”€â”€ Hang Up â”€â”€â”€â”€â”€â”€â†’â”‚                   â”‚                    â”‚
  â”‚                   â”‚â”€ disconnect â”€â”€â”€â”€â”€â†’â”‚â”€â”€â”€ close â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
```

---

## State Machine Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CALL_RECEIVED  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ANSWERING_CALL     â”‚
â”‚  - Create handler    â”‚
â”‚  - Setup handlers    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONNECTING_OPENAI    â”‚
â”‚  - WebSocket init    â”‚
â”‚  - Session update    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MEDIA_READY        â”‚
â”‚  - Play beep         â”‚
â”‚  - Attach recorder   â”‚
â”‚  - Attach player     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SENDING_GREETING     â”‚
â”‚  - Generate/cache    â”‚
â”‚  - Stream audio      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LISTENING           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (VAD enabled)        â”‚                      â”‚
â”‚ Waiting for speech   â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                                    â”‚
         â”‚ speech_started                     â”‚
         â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  RECORDING_AUDIO     â”‚                      â”‚
â”‚ Streaming to OpenAI  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                                    â”‚
         â”‚ speech_stopped                     â”‚
         â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ COMMITTING_INPUT     â”‚                      â”‚
â”‚ Finalize user input  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                                    â”‚
         â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   PROCESSING         â”‚                      â”‚
â”‚ OpenAI generating    â”‚                      â”‚
â”‚ response             â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                                    â”‚
         â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ STREAMING_RESPONSE   â”‚                      â”‚
â”‚ Audio deltas arrivingâ”‚                      â”‚
â”‚ Playing to caller    â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                                    â”‚
         â”‚ response.done                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Timing Diagram

```
Timeline (seconds):
0â”€â”€â”€â”€â”¬â”€â”€â”€â”€1â”€â”€â”€â”€â”¬â”€â”€â”€â”€2â”€â”€â”€â”€â”¬â”€â”€â”€â”€3â”€â”€â”€â”€â”¬â”€â”€â”€â”€4â”€â”€â”€â”€â”¬â”€â”€â”€â”€5â”€â”€â”€â”€â”¬â”€â”€â”€â”€6â”€â”€â”€â”€â”¬â”€â”€â”€â”€7â”€â”€â–º
     â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
  [Call]      [WS Conn]  [Beep]   [Greeting Start]   [Greeting] [Ready]
     â”‚         â”‚         â”‚         â”‚         â”‚    [Play Audio]   â”‚
     â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
  Call         OpenAI    Media    Greeting  Audio      Stream    Listening
  Received    Connected  Ready    Generated Deltas    Complete   Start
     â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
  Delay:       100ms     500ms     ~500ms    ~2s      ~3s       Total: 5-7s
    0ms
```

---

## Critical Points

### â­ Audio Buffer Commitment
The **`input_audio_buffer.commit`** message is critical:
- **When**: After `speech_stopped` VAD event
- **Why**: Signals to OpenAI that user has finished speaking
- **Without it**: Response would be delayed or not generated
- **Impact**: Enables proper turn-taking

### â­ Audio Chunk Streaming
The **100ms monitoring interval** is important:
- Balances real-time responsiveness with CPU usage
- Ensures smooth streaming to OpenAI
- Allows VAD to detect natural speech pauses

### â­ Greeting Caching
Caching greeting saves resources:
- First call: ~3 seconds to generate greeting
- Subsequent calls: ~100ms to play cached greeting
- Improves user experience on repeated calls

---

## Event Handler Flow

```
handleOpenAIMessage(message)
  â”‚
  â”œâ”€â–º message.type
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'session.created'
  â”‚   â”‚   â””â”€â–º Session ready
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'session.updated'
  â”‚   â”‚   â””â”€â–º Configuration applied
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'response.audio.delta'
  â”‚   â”‚   â””â”€â–º playAudioToSIP()
  â”‚   â”‚       â”œâ”€â–º Decode Base64
  â”‚   â”‚       â”œâ”€â–º Create WAV
  â”‚   â”‚       â””â”€â–º Play to caller
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'input_audio_buffer.speech_started'
  â”‚   â”‚   â””â”€â–º User began speaking
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'input_audio_buffer.speech_stopped'
  â”‚   â”‚   â””â”€â–º commitAudioBuffer()
  â”‚   â”‚       â””â”€â–º Send commit message
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'response.created'
  â”‚   â”‚   â””â”€â–º OpenAI preparing response
  â”‚   â”‚
  â”‚   â”œâ”€â–º 'response.done'
  â”‚   â”‚   â””â”€â–º Response complete
  â”‚   â”‚       â”œâ”€â–º Check if greeting
  â”‚   â”‚       â””â”€â–º Cache if needed
  â”‚   â”‚
  â”‚   â””â”€â–º 'error'
  â”‚       â””â”€â–º Log error
```

