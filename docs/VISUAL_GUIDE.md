# OpenAI Integration - Visual Guide

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TURKISH SIP PHONE SYSTEM                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SIP Caller      â”‚
â”‚  ğŸ“ User dials   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              [SIP Server - app.js]                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Call Management Layer                                   â”‚  â”‚
â”‚  â”‚  âœ“ Accept incoming calls                                â”‚  â”‚
â”‚  â”‚  âœ“ Answer calls                                         â”‚  â”‚
â”‚  â”‚  âœ“ Track call state                                     â”‚  â”‚
â”‚  â”‚  âœ“ Manage media streams                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Audio Playback                                          â”‚  â”‚
â”‚  â”‚  â–¶ï¸  sample.wav (12.0 seconds)                           â”‚  â”‚
â”‚  â”‚  â–¶ï¸  beethoven.wav (7.5 seconds)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Audio Recording                                         â”‚  â”‚
â”‚  â”‚  ğŸ™ï¸  Record caller input                                â”‚  â”‚
â”‚  â”‚  ğŸ“  Save to /tmp/caller_*.wav                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Conversation Loop (Repeats until call ends)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  1. TRANSCRIBE                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ¤ Caller audio â†’ Turkish text                  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  (Whisper API)                                    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚             â†“                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  2. PROCESS                                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ’¬ Generate response with context                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  (GPT-4 mini)                                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ“š Maintain conversation history                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚             â†“                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  3. SYNTHESIZE                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸµ Response text â†’ Audio (TTS)                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  (Text-to-Speech API)                             â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚             â†“                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  4. PLAY                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ”Š Play response to caller                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ“¡ Transmit via SIP media stream                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚             â†“                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  5. LISTEN                                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ‘‚ Wait for next caller input (10s)              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ”„ Loop back to step 1                           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚             â†“ (repeat)                                   â”‚  â”‚
â”‚  â”‚          [LOOP]                                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  When call ends:                                         â”‚  â”‚
â”‚  â”‚  âœ“ Stop listening                                       â”‚  â”‚
â”‚  â”‚  âœ“ Close media streams                                 â”‚  â”‚
â”‚  â”‚  âœ“ Stop recording                                      â”‚  â”‚
â”‚  â”‚  âœ“ Log conversation summary                            â”‚  â”‚
â”‚  â”‚  âœ“ Cleanup temp files                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
   Call Ends (DISCONNECTED)
   ğŸ“Š Summary logged to console
```

## Data Flow - Single Exchange

```
Caller: "Merhaba, ben Ahmet"
    â”‚
    â†“ (transmitted via SIP RTP)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SIP Media Stream     â”‚
â”‚ (Audio Data)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ RECORD          â”‚
    â”‚ Save to WAV fileâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
   /tmp/caller_[ID].wav
   (45.2 KB audio file)
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ openai-handler.js                       â”‚
    â”‚ transcribeAudio(audioBuffer)            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ (HTTP POST to OpenAI)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OpenAI Whisper API                      â”‚
    â”‚ /v1/audio/transcriptions                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    "Merhaba, ben Ahmet"
    (Turkish text)
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ openai-handler.js                       â”‚
    â”‚ getAIResponse(text, history)            â”‚
    â”‚ - Add to conversationHistory            â”‚
    â”‚ - Send to ChatGPT with context          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ (HTTP POST to OpenAI)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OpenAI ChatGPT API                      â”‚
    â”‚ /v1/chat/completions                    â”‚
    â”‚ model: gpt-4o-mini                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    "Merhaba Ahmet! Size nasÄ±l yardÄ±mcÄ±
     olabilirim?"
    (AI Response in Turkish)
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ openai-handler.js                       â”‚
    â”‚ textToSpeech(response, 'nova')          â”‚
    â”‚ - Convert text to natural speech        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ (HTTP POST to OpenAI)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OpenAI Text-to-Speech API               â”‚
    â”‚ /v1/audio/speech                        â”‚
    â”‚ voice: nova                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
   /tmp/tts_[ID].wav
   (MP3 converted to WAV)
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ app.js                                  â”‚
    â”‚ CREATE PLAYER                           â”‚
    â”‚ player = sip.createPlayer(audioPath)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ app.js                                  â”‚
    â”‚ START TRANSMISSION                      â”‚
    â”‚ player.startTransmitTo(mediaStream)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ (Audio frames via RTP)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SIP Media Stream (Response)              â”‚
    â”‚ Audio transmitted to caller              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
         Caller hears:
    "Merhaba Ahmet! Size nasÄ±l yardÄ±mcÄ±
     olabilirim?"
```

## Conversation History Example

```javascript
// Initial state
conversationHistory = [];

// After first exchange
conversationHistory = [
  {
    role: 'user',
    content: 'Merhaba, ben Ahmet'
  },
  {
    role: 'assistant',
    content: 'Merhaba Ahmet! Size nasÄ±l yardÄ±mcÄ± olabilirim?'
  }
];

// After second exchange
conversationHistory = [
  {
    role: 'user',
    content: 'Merhaba, ben Ahmet'
  },
  {
    role: 'assistant',
    content: 'Merhaba Ahmet! Size nasÄ±l yardÄ±mcÄ± olabilirim?'
  },
  {
    role: 'user',
    content: 'BugÃ¼nÃ¼n tarihi kaÃ§?'
  },
  {
    role: 'assistant',
    content: 'BugÃ¼n 17 Ekim 2025'
  }
];

// Sent to ChatGPT API to maintain context:
{
  role: 'system',
  content: 'You are a helpful Turkish-speaking AI assistant...'
},
{
  role: 'user',
  content: 'Merhaba, ben Ahmet'
},
{
  role: 'assistant',
  content: 'Merhaba Ahmet! Size nasÄ±l yardÄ±mcÄ± olabilirim?'
},
{
  role: 'user',
  content: 'BugÃ¼nÃ¼n tarihi kaÃ§?'  â† ChatGPT sees context
},
// ChatGPT generates response based on full history
```

## Call State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   START     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Incoming call
â”‚   LISTENING      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€received
â”‚   (ringing)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Answer
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CONFIRMING     â”‚     Call answered,
â”‚   (early media)  â”‚     media negotiating
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Media available
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CONFIRMED      â”‚     â–¶ï¸  Play greeting
â”‚   (active call)  â”‚     ğŸ™ï¸ Record caller
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                             â”‚
       â†“                             â†“
   LOOP: LISTEN              (every 10 seconds)
   Record input â”€â”€â”€â”€â”€â”€â†’ Transcribe â†’ Process â†’ Speak
       â†‘                           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       
       (Until caller hangs up)
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DISCONNECTING   â”‚     Stop processes,
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     cleanup resources
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DISCONNECTED     â”‚     Log conversation,
â”‚  (call ended)    â”‚     delete temp files
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
    [END]
```

## File Organization

```
openai-handler.js (217 lines)
â”‚
â”œâ”€ initializeRealtimeSession()
â”‚  â””â”€ Returns: { isActive, conversationHistory }
â”‚
â”œâ”€ transcribeAudio(audioBuffer)
â”‚  â”œâ”€ Write to temp file
â”‚  â”œâ”€ Call Whisper API
â”‚  â””â”€ Returns: Turkish text
â”‚
â”œâ”€ getAIResponse(message, history)
â”‚  â”œâ”€ Add message to history
â”‚  â”œâ”€ Call ChatGPT API
â”‚  â”œâ”€ Update history with response
â”‚  â””â”€ Returns: AI response text
â”‚
â”œâ”€ textToSpeech(text, voice)
â”‚  â”œâ”€ Call TTS API
â”‚  â”œâ”€ Convert response to buffer
â”‚  â”œâ”€ Save to temp file
â”‚  â””â”€ Returns: audio file path
â”‚
â”œâ”€ processUserAudio(buffer, history)
â”‚  â”œâ”€ Transcribe
â”‚  â”œâ”€ Get AI response
â”‚  â”œâ”€ Text to speech
â”‚  â””â”€ Returns: { userMessage, aiResponse, audioPath }
â”‚
â””â”€ cleanupAudioFile(path)
   â””â”€ Delete temp file
```

## Timeline of a 10-Second Call

```
0s   â”‚ Incoming call received
     â”‚ âœ… Call answered
     â”œâ”€ â–¶ï¸  sample.wav starts (12s audio file)
     â”‚
12s  â”‚ sample.wav ends
     â”œâ”€ â–¶ï¸  beethoven.wav starts (7.5s audio file)
     â”‚
19.5sâ”‚ beethoven.wav ends
     â”‚ ğŸ¤ "Please speak now"
     â”‚
29.5sâ”‚ â±ï¸  Timeout - Stop listening
     â”‚ ğŸ“Š Audio recorded: 45.2 KB
     â”‚ ğŸ¤ Transcribing... (1-2s)
     â”‚
31s  â”‚ ğŸ“ "Merhaba, ben Ahmet"
     â”‚ ğŸ’¬ Generating response... (1s)
     â”‚
32s  â”‚ ğŸ¤– "Merhaba Ahmet! Size nasÄ±l yardÄ±mcÄ± olabilirim?"
     â”‚ ğŸµ Converting to speech... (1-2s)
     â”‚
34s  â”‚ âœ… TTS complete (/tmp/tts_12345.wav)
     â”‚ ğŸ”Š Playing response (3.5s)
     â”‚
37.5sâ”‚ Response finished
     â”‚ ğŸ¤ Listening again... (another 10s)
     â”‚
47.5sâ”‚ Caller hangs up
     â”‚ ğŸ§¹ Cleanup
     â”‚ ğŸ’¬ Log conversation:
     â”‚    1. ğŸ‘¤ User: "Merhaba, ben Ahmet"
     â”‚    2. ğŸ¤– AI: "Merhaba Ahmet..."
     â”‚
48s  â”‚ [CALL END]
```

## Cost Per Call Example

```
5-minute call with 3 exchanges:

Exchange 1:
â”œâ”€ Transcription (Whisper)     : $0.02  [2 Ã— 15s round up]
â”œâ”€ Chat completion (GPT-4m)    : $0.0001 [~100 tokens]
â””â”€ TTS (120 characters)        : $0.0036 [$0.030/1K Ã— 120]
   Subtotal: $0.0237

Exchange 2:
â”œâ”€ Transcription               : $0.02
â”œâ”€ Chat completion             : $0.0001
â””â”€ TTS (100 characters)        : $0.003
   Subtotal: $0.0231

Exchange 3:
â”œâ”€ Transcription               : $0.02
â”œâ”€ Chat completion             : $0.0001
â””â”€ TTS (90 characters)         : $0.0027
   Subtotal: $0.0228

TOTAL FOR CALL: $0.0696 â‰ˆ $0.07

Annual cost (100 calls/day):
365 Ã— 100 Ã— $0.07 = $2,555/year
```

## Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SIP Calls     â”‚
â”‚  (sipstel)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Audio RTP streams
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  app.js                    â”‚ 
    â”‚  â”œâ”€ Accept calls           â”‚
    â”‚  â”œâ”€ Play greeting          â”‚
    â”‚  â”œâ”€ Record audio           â”‚
    â”‚  â””â”€ Loop handler           â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”˜
         â”‚                      â”‚
         â”‚                  Temp files
         â”‚                /tmp/caller_*
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ openai-handler.js         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ â”œâ”€ transcribeAudio()      â”‚â”€â”€â”€â”€â†’â”‚ Whisper API     â”‚
    â”‚ â”œâ”€ getAIResponse()        â”‚â”€â”€â”€â”€â†’â”‚ ChatGPT API     â”‚
    â”‚ â”œâ”€ textToSpeech()         â”‚â”€â”€â”€â”€â†’â”‚ TTS API         â”‚
    â”‚ â””â”€ processUserAudio()     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (over HTTPS)
```

---

This visual guide shows how all components work together to create an interactive Turkish-language phone system! ğŸ‰
